"use strict";(self.webpackChunklearning_knowledge_base=self.webpackChunklearning_knowledge_base||[]).push([[4416],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return m}});var i=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,i,n=function(e,t){if(null==e)return{};var a,i,n={},o=Object.keys(e);for(i=0;i<o.length;i++)a=o[i],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)a=o[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=i.createContext({}),c=function(e){var t=i.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},u=function(e){var t=c(e.components);return i.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},p=i.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),p=c(a),m=n,h=p["".concat(s,".").concat(m)]||p[m]||d[m]||o;return a?i.createElement(h,l(l({ref:t},u),{},{components:a})):i.createElement(h,l({ref:t},u))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,l=new Array(o);l[0]=p;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:n,l[1]=r;for(var c=2;c<o;c++)l[c]=a[c];return i.createElement.apply(null,l)}return i.createElement.apply(null,a)}p.displayName="MDXCreateElement"},9298:function(e,t,a){a.r(t),a.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return r},metadata:function(){return c},toc:function(){return d}});var i=a(7462),n=a(3366),o=(a(7294),a(3905)),l=["components"],r={id:"dllSideLoading",title:"DLL Side-Loading",sidebar_position:3},s=void 0,c={unversionedId:"Security/dllSideLoading",id:"Security/dllSideLoading",title:"DLL Side-Loading",description:"- Category: Defense Evasion",source:"@site/docs/Security/DLL Side-Loading.md",sourceDirName:"Security",slug:"/Security/dllSideLoading",permalink:"/LearningCollection/Security/dllSideLoading",editUrl:"https://github.com/RobinTTY/LearningCollection/tree/master/website/docs/Security/DLL Side-Loading.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"dllSideLoading",title:"DLL Side-Loading",sidebar_position:3},sidebar:"mySidebar",previous:{title:"Trusted Developer Utilities Proxy Execution",permalink:"/LearningCollection/Security/trustedDeveloperUtilities"},next:{title:"Metasploit",permalink:"/LearningCollection/Security/Kali Linux/Metasploit"}},u={},d=[{value:"Traditional DLL-Side loading on Windows",id:"traditional-dll-side-loading-on-windows",level:2},{value:"Examples of DLL Side-Loading",id:"examples-of-dll-side-loading",level:2},{value:"Operation Clandestine Fox",id:"operation-clandestine-fox",level:3},{value:"Initial Contact",id:"initial-contact",level:4},{value:"The E-Mail Attachments",id:"the-e-mail-attachments",level:4},{value:"What we can learn",id:"what-we-can-learn",level:2},{value:"Mitigations",id:"mitigations",level:2},{value:"Detection",id:"detection",level:2}],p={toc:d};function m(e){var t=e.components,a=(0,n.Z)(e,l);return(0,o.kt)("wrapper",(0,i.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Category: Defense Evasion"),(0,o.kt)("li",{parentName:"ul"},"Technique: Hijack Execution Flow"),(0,o.kt)("li",{parentName:"ul"},"Goal: Execute malicious payload")),(0,o.kt)("p",null,"References:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"MITRE: ",(0,o.kt)("a",{parentName:"li",href:"https://attack.mitre.org/techniques/T1574/002/"},"Hijack Execution Flow: DLL Side-Loading")),(0,o.kt)("li",{parentName:"ul"},"FireEye: ",(0,o.kt)("a",{parentName:"li",href:"https://www.mandiant.com/media/10376/download"},"DLL SIDE-LOADING: A THORN IN THE SIDE OF THE ANTI-VIRUS INDUSTRY - 2014"))),(0,o.kt)("p",null,"DLL Side-Loading involves execution of a malicious payload in form of a DLL. Rather than just planting the DLL within the search order of a program (to await invocation by a user process) the adversaries may directly side-load the payload by invoking a legitimate application that executes the payload."),(0,o.kt)("h2",{id:"traditional-dll-side-loading-on-windows"},"Traditional DLL-Side loading on Windows"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Windows, like many operating systems, allows applications to load DLLs at runtime"),(0,o.kt)("li",{parentName:"ul"},"Applications can specify the location of DLLs by specifying a full path, using DLL redirection, or by using a manifest."),(0,o.kt)("li",{parentName:"ul"},"If none of these methods are used, Windows attempts to locate the DLL by searching a ",(0,o.kt)("strong",{parentName:"li"},"predefined set of directories")," in a set order"),(0,o.kt)("li",{parentName:"ul"},"This fact can be abused by placing a malicious DLL in one of these directories",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"In these cases Windows reaches the malicious DLL before finding the legitimate version")))),(0,o.kt)("p",null,"Side-loading ",(0,o.kt)("strong",{parentName:"p"},"takes advantage of the DLL search order")," used by the loader by positioning both the victim application and malicious payload(s) alongside each other. Executables used to side-load payloads may not be flagged during delivery and/or execution which makes them a good way to evade detection."),(0,o.kt)("p",null,"The payload itself may also be encrypted/packed or otherwise obfuscated until loaded into memory of the trusted process."),(0,o.kt)("h2",{id:"examples-of-dll-side-loading"},"Examples of DLL Side-Loading"),(0,o.kt)("h3",{id:"operation-clandestine-fox"},"Operation Clandestine Fox"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Attack originating from APT3, a China-based group which researchers have attributed to China's Ministry of State Security"),(0,o.kt)("li",{parentName:"ul"},"Attack was carried out in 2014"),(0,o.kt)("li",{parentName:"ul"},"Target were companies in the energy sector")),(0,o.kt)("h4",{id:"initial-contact"},"Initial Contact"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The initial attack vector is social engineering: An e-mail is sent which is made to look like a job application"),(0,o.kt)("li",{parentName:"ul"},"The e-mail contains an attachment with a resume and ",(0,o.kt)("strong",{parentName:"li"},"sample software")," the applicant has written"),(0,o.kt)("li",{parentName:"ul"},"The applicant had previously contacted the employee who received the e-mail via a social network, to make it look more legitimate"),(0,o.kt)("li",{parentName:"ul"},"Before the e-mail was sent, there had been three weeks of communication between applicant and employee")),(0,o.kt)("p",null,"The email contained the following:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Hi Michael,"),(0,o.kt)("p",{parentName:"blockquote"},"Attached is my resume and the software I developed for my Uncle who is a researcher in new material. Last week I was busy with my partners to develop a control system. Thank you very much. Wish to be a member of your company."),(0,o.kt)("p",{parentName:"blockquote"},"Emily")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"FireEye investigated this attack and found some inconsistencies in the social profile of the alleged applicant:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"She had some fake education history"),(0,o.kt)("li",{parentName:"ul"},"She also had additional contacts at the victim's company"),(0,o.kt)("li",{parentName:"ul"},"She had inquired about who the IT Manger was and what versions of software they ran with her other contacts")))),(0,o.kt)("p",null,"The attacker used e-mail and social networks to communicate with her various contacts. Worth noting is that the attacker used the private e-mail addresses of employees to contact them, possibly to circumvent the more sophisticated corporate e-mail security but maybe just because employees had linked their personal e-mail to the social network instead of the work address."),(0,o.kt)("h4",{id:"the-e-mail-attachments"},"The E-Mail Attachments"),(0,o.kt)("p",null,"Attached to the E-Mail was a single ",(0,o.kt)("strong",{parentName:"p"},'"resume.rar"')," file. This archive was sent to different companies and didn't always contain the same files. The archive with the sideloading attack looked as follows:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"SETUP.exe"),(0,o.kt)("li",{parentName:"ul"},"my resume.pdf")),(0,o.kt)("p",null,'This archive was protected by the password "TTcalc".'),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"SETUP.exe")," is a self executing RAR archive containting more files:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ttcalc.exe"),(0,o.kt)("li",{parentName:"ul"},"ttcalcBAK.exe"),(0,o.kt)("li",{parentName:"ul"},"ttcalc.chm"),(0,o.kt)("li",{parentName:"ul"},"README"),(0,o.kt)("li",{parentName:"ul"},"CHANGELOG"),(0,o.kt)("li",{parentName:"ul"},"COPYRIGHT")),(0,o.kt)("p",null,"When the SETUP.exe is executed it opens the WinRAR window, prompting the user for the location to extract the files to."),(0,o.kt)("p",null,"The files are written to a TTCalc folder and it is tried to launch ttcalcBAK.exe (the malware dropper) but the path is incorrect so it fails with an error message. All other files are benign and related to the legitimate TTCalc application."),(0,o.kt)("p",null,"TTCalc is a scientific calculator."),(0,o.kt)("p",null,"ttcalcBAK.exe is also a self-extracting RAR which drops and launches ",(0,o.kt)("em",{parentName:"p"},"chrome_frame_helper"),". Chrome frame helper dll is a file that belongs to Google Chrome Frame, a plugin for Internet Explorer that enables Internet Explorer to display web pages in Google Chrome's rendering style. The project was retired in 2014."),(0,o.kt)("p",null,"In this case the file is a ",(0,o.kt)("a",{parentName:"p",href:"https://www.fireeye.com/blog/threat-research/2014/07/pacific-ring-of-fire-plugx-kaba.html"},"Backdoor"),", it uses a legitimate Chrome executable to ",(0,o.kt)("strong",{parentName:"p"},"load the malicious DLL via side-loading"),". According to FireEye this kind of malware was quiet common at the time (2014)."),(0,o.kt)("p",null,"Now with the actual malcode loaded the malware would start to communicate with the Command and Control Server."),(0,o.kt)("h2",{id:"what-we-can-learn"},"What we can learn"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Very often the attack vector is social engineering and if we are more cautious about these interactions we can avoid possible attacks"),(0,o.kt)("li",{parentName:"ul"},"Don't use your personal Mail for business communication purposes")),(0,o.kt)("h2",{id:"mitigations"},"Mitigations"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Train developers of applications so they know how to avoid introducing DLL Side-Loading vulnerabilities"),(0,o.kt)("li",{parentName:"ul"},"Train users of applications that might be vulnerable to DLL Side-Loading attacks"),(0,o.kt)("li",{parentName:"ul"},"Restrict possibly abused functionality in applications if possible (e.g. Excel/Word Macros, etc.)"),(0,o.kt)("li",{parentName:"ul"},"Keep software up to date")),(0,o.kt)("h2",{id:"detection"},"Detection"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Monitor running processes on your machine for unusual activity",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"e.g. a process that does not usually use the network begins to do so"))),(0,o.kt)("li",{parentName:"ul"},"Monitor the introduction of new files/programs"),(0,o.kt)("li",{parentName:"ul"},"Track DLL metadata",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"e.g. compute a hash of the DLL and validate it before loading it for process execution (you need to account for updates/patching)")))))}m.isMDXComponent=!0}}]);