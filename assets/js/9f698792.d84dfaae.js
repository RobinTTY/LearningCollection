"use strict";(self.webpackChunklearning_knowledge_base=self.webpackChunklearning_knowledge_base||[]).push([[5891],{60623:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"cloud/aws/certified-developer-associate/advanced-identity","title":"Advanced Identity","description":"AWS STS \u2013 Security Token Service","source":"@site/docs/cloud/aws/certified-developer-associate/advanced-identity.md","sourceDirName":"cloud/aws/certified-developer-associate","slug":"/cloud/aws/certified-developer-associate/advanced-identity","permalink":"/LearningCollection/cloud/aws/certified-developer-associate/advanced-identity","draft":false,"unlisted":false,"editUrl":"https://github.com/RobinTTY/LearningCollection/tree/master/website/docs/cloud/aws/certified-developer-associate/advanced-identity.md","tags":[],"version":"current","sidebarPosition":25,"frontMatter":{"title":"Advanced Identity","sidebar_position":25},"sidebar":"docs","previous":{"title":"Miscellaneous Serverless","permalink":"/LearningCollection/cloud/aws/certified-developer-associate/misc-serverless"},"next":{"title":"Security & Encryption","permalink":"/LearningCollection/cloud/aws/certified-developer-associate/security-encryption"}}');var l=n(74848),r=n(28453);const c={title:"Advanced Identity",sidebar_position:25},t=void 0,o={},a=[{value:"AWS STS \u2013 Security Token Service",id:"aws-sts--security-token-service",level:2},{value:"Using STS to Assume a Role",id:"using-sts-to-assume-a-role",level:3},{value:"Cross account access with STS",id:"cross-account-access-with-sts",level:3},{value:"STS with MFA",id:"sts-with-mfa",level:3},{value:"IAM Best Practices",id:"iam-best-practices",level:2},{value:"General",id:"general",level:3},{value:"IAM Roles",id:"iam-roles",level:3},{value:"Cross Account Access",id:"cross-account-access",level:3},{value:"Authorization Model Evaluation of Policies",id:"authorization-model-evaluation-of-policies",level:2},{value:"IAM Policies &amp; S3 Bucket Policies",id:"iam-policies--s3-bucket-policies",level:2},{value:"Example 1",id:"example-1",level:3},{value:"Example 2",id:"example-2",level:3},{value:"Example 3",id:"example-3",level:3},{value:"Example 4",id:"example-4",level:3},{value:"Dynamic Policies with IAM",id:"dynamic-policies-with-iam",level:3},{value:"Inline vs Managed Policies",id:"inline-vs-managed-policies",level:3},{value:"Granting a User Permissions to Pass a Role to an AWS Service",id:"granting-a-user-permissions-to-pass-a-role-to-an-aws-service",level:3},{value:"What is Microsoft Active Directory (AD)?",id:"what-is-microsoft-active-directory-ad",level:2},{value:"AWS Directory Services",id:"aws-directory-services",level:3}];function d(e){const i={code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(i.h2,{id:"aws-sts--security-token-service",children:"AWS STS \u2013 Security Token Service"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Allows to grant limited and temporary access to AWS resources (up to 1 hour)."}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"AssumeRole"}),": Assume roles within your account or cross account"]}),"\n",(0,l.jsx)(i.li,{children:"AssumeRoleWithSAML: return credentials for users logged with SAML"}),"\n",(0,l.jsxs)(i.li,{children:["AssumeRoleWithWebIdentity","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"return creds for users logged with an IdP (Facebook Login, Google Login, OIDC compatible\u2026)"}),"\n",(0,l.jsx)(i.li,{children:"AWS recommends against using this, and using Cognito Identity Pools instead"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"GetSessionToken"}),": for MFA, from a user or AWS account root user"]}),"\n",(0,l.jsx)(i.li,{children:"GetFederationToken: obtain temporary creds for a federated user"}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"GetCallerIdentity"}),": return details about the IAM user or role used in the API call"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"DecodeAuthorizationMessage"}),": decode error message when an AWS API is denied"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"using-sts-to-assume-a-role",children:"Using STS to Assume a Role"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Define an IAM Role within your account or cross-account"}),"\n",(0,l.jsx)(i.li,{children:"Define which principals can access this IAM Role"}),"\n",(0,l.jsx)(i.li,{children:"Use AWS STS (Security Token Service) to retrieve credentials and impersonate the IAM Role you have access to (AssumeRole API)"}),"\n",(0,l.jsx)(i.li,{children:"Temporary credentials can be valid between 15 minutes to 1 hour"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:(0,l.jsx)(i.img,{alt:"sts-to-assume-a-role",src:n(27181).A+"",width:"318",height:"269"})}),"\n",(0,l.jsx)(i.h3,{id:"cross-account-access-with-sts",children:"Cross account access with STS"}),"\n",(0,l.jsx)(i.p,{children:(0,l.jsx)(i.img,{alt:"cross-account-sts",src:n(70220).A+"",width:"494",height:"216"})}),"\n",(0,l.jsx)(i.h3,{id:"sts-with-mfa",children:"STS with MFA"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Use GetSessionToken from STS"}),"\n",(0,l.jsxs)(i.li,{children:["Appropriate IAM policy using IAM Conditions","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["aws:MultiFactorAuthPresent",":true"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["Reminder, GetSessionToken returns:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Access ID"}),"\n",(0,l.jsx)(i.li,{children:"Secret Key"}),"\n",(0,l.jsx)(i.li,{children:"Session Token"}),"\n",(0,l.jsx)(i.li,{children:"Expiration date"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"iam-best-practices",children:"IAM Best Practices"}),"\n",(0,l.jsx)(i.h3,{id:"general",children:"General"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Never use Root Credentials, enable MFA for Root Account"}),"\n",(0,l.jsx)(i.li,{children:"Grant Least Privilege"}),"\n",(0,l.jsx)(i.li,{children:"Each Group / User / Role should only have the minimum level of permission it needs"}),"\n",(0,l.jsx)(i.li,{children:"Never grant a policy with \u201c*\u201d access to a service"}),"\n",(0,l.jsx)(i.li,{children:"Monitor API calls made by a user in CloudTrail (especially Denied ones)"}),"\n",(0,l.jsx)(i.li,{children:"Never ever ever store IAM key credentials on any machine but a personal computer or on-premise server"}),"\n",(0,l.jsx)(i.li,{children:"On premise server best practice is to call STS to obtain temporary security credentials"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"iam-roles",children:"IAM Roles"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"EC2 machines should have their own roles"}),"\n",(0,l.jsx)(i.li,{children:"Lambda functions should have their own roles"}),"\n",(0,l.jsx)(i.li,{children:"ECS Tasks should have their own roles (ECS_ENABLE_TASK_IAM_ROLE=true)"}),"\n",(0,l.jsx)(i.li,{children:"CodeBuild should have its own service role"}),"\n",(0,l.jsx)(i.li,{children:"Create a least-privileged role for any service that requires it"}),"\n",(0,l.jsx)(i.li,{children:"Create a role per application / lambda function (do not reuse roles)"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"cross-account-access",children:"Cross Account Access"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Define an IAM Role for another account to access"}),"\n",(0,l.jsx)(i.li,{children:"Define which accounts can access this IAM Role"}),"\n",(0,l.jsx)(i.li,{children:"Use AWS STS (Security Token Service) to retrieve credentials and impersonate the IAM Role you have access to (AssumeRole API)"}),"\n",(0,l.jsx)(i.li,{children:"Temporary credentials can be valid between 15 minutes to 1 hour"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:(0,l.jsx)(i.img,{alt:"iam-cross-account",src:n(19347).A+"",width:"297",height:"267"})}),"\n",(0,l.jsx)(i.h2,{id:"authorization-model-evaluation-of-policies",children:"Authorization Model Evaluation of Policies"}),"\n",(0,l.jsxs)(i.ol,{children:["\n",(0,l.jsx)(i.li,{children:"If there\u2019s an explicit DENY, end decision and DENY"}),"\n",(0,l.jsx)(i.li,{children:"If there\u2019s an ALLOW, end decision with ALLOW"}),"\n",(0,l.jsx)(i.li,{children:"Else DENY"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"iam-policies--s3-bucket-policies",children:"IAM Policies & S3 Bucket Policies"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"IAM Policies are attached to users, roles, groups"}),"\n",(0,l.jsx)(i.li,{children:"S3 Bucket Policies are attached to buckets"}),"\n",(0,l.jsx)(i.li,{children:"When evaluating if an IAM Principal can perform an operation X on a bucket, the union of its assigned IAM Policies and S3 Bucket policies will be evaluated."}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"example-1",children:"Example 1"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"IAM Role attached to EC2 instance, authorizes RW to \u201cmy_bucket\u201d"}),"\n",(0,l.jsx)(i.li,{children:"No S3 Bucket Policy attached"}),"\n",(0,l.jsx)(i.li,{children:"=> EC2 instance can read and write to \u201cmy_bucket\u201d"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"example-2",children:"Example 2"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"IAM Role attached to EC2 instance, authorizes RW to \u201cmy_bucket\u201d"}),"\n",(0,l.jsx)(i.li,{children:"S3 Bucket Policy attached, explicit deny"}),"\n",(0,l.jsx)(i.li,{children:"=> EC2 instance cannot to the IAM Role read and write to \u201cmy_bucket\u201d"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"example-3",children:"Example 3"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"IAM Role attached to EC2 instance, no S3 bucket permissions"}),"\n",(0,l.jsx)(i.li,{children:"S3 Bucket Policy attached, explicit RW allow"}),"\n",(0,l.jsx)(i.li,{children:"=> EC2 instance can to the IAM Role read and write to \u201cmy_bucket\u201d"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"example-4",children:"Example 4"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"IAM Role attached to EC2 instance, explicit deny S3 bucket permissions"}),"\n",(0,l.jsx)(i.li,{children:"S3 Bucket Policy attached, explicit RW allow"}),"\n",(0,l.jsx)(i.li,{children:"=> EC2 instance cannot to the IAM Role read and write to \u201cmy_bucket\u201d"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"dynamic-policies-with-iam",children:"Dynamic Policies with IAM"}),"\n",(0,l.jsxs)(i.p,{children:["How do you assign each user a ",(0,l.jsx)(i.code,{children:"/home/<user>"})," folder in an S3 bucket?"]}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Option 1:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Create an IAM policy allowing georges to have access to /home/georges"}),"\n",(0,l.jsx)(i.li,{children:"Create an IAM policy allowing sarah to have access to /home/sarah"}),"\n",(0,l.jsx)(i.li,{children:"Create an IAM policy allowing matt to have access to /home/matt"}),"\n",(0,l.jsx)(i.li,{children:"\u2026 One policy per user!"}),"\n",(0,l.jsx)(i.li,{children:"This doesn\u2019t scale"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["Option 2:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Create one dynamic policy with IAM"}),"\n",(0,l.jsxs)(i.li,{children:["Leverage the special policy variable ",(0,l.jsx)(i.code,{children:"${aws:username}"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-json",children:'{\n  "Sid": "AllowAllS3ActionsInUserFolder",\n  "Action": ["s3:*"],\n  "Effect": "Allow",\n  "Resource": ["arn:aws:s3:::my-company/home/${aws:username}/*"]\n}\n'})}),"\n",(0,l.jsx)(i.h3,{id:"inline-vs-managed-policies",children:"Inline vs Managed Policies"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["AWS Managed Policy","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Maintained by AWS"}),"\n",(0,l.jsx)(i.li,{children:"Good for power users and administrators"}),"\n",(0,l.jsx)(i.li,{children:"Updated in case of new services / new APIs"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["Customer Managed Policy","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Best Practice, re-usable, can be applied to many principals"}),"\n",(0,l.jsx)(i.li,{children:"Version Controlled + rollback, central change management"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["Inline","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Strict one-to-one relationship between policy and principal"}),"\n",(0,l.jsx)(i.li,{children:"Policy is deleted if you delete the IAM principal"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"granting-a-user-permissions-to-pass-a-role-to-an-aws-service",children:"Granting a User Permissions to Pass a Role to an AWS Service"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"To configure many AWS services, you must pass an IAM role to the service (this happens only once during setup)"}),"\n",(0,l.jsx)(i.li,{children:"The service will later assume the role and perform actions"}),"\n",(0,l.jsxs)(i.li,{children:["Example of passing a role:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"To an EC2 instance"}),"\n",(0,l.jsx)(i.li,{children:"To a Lambda function"}),"\n",(0,l.jsx)(i.li,{children:"To an ECS task"}),"\n",(0,l.jsx)(i.li,{children:"To CodePipeline to allow it to invoke other services"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["For this, you need the IAM permission iam",":PassRole"]}),"\n",(0,l.jsxs)(i.li,{children:["It often comes with iam",":GetRole"," to view the role being passed"]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:(0,l.jsx)(i.img,{alt:"iam-pass-role",src:n(60689).A+"",width:"384",height:"247"})}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Roles can only be passed to what their trust allows"}),"\n",(0,l.jsx)(i.li,{children:"A trust policy for the role that allows the service to assume the role"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:(0,l.jsx)(i.img,{alt:"trust-policy",src:n(16744).A+"",width:"542",height:"200"})}),"\n",(0,l.jsx)(i.h2,{id:"what-is-microsoft-active-directory-ad",children:"What is Microsoft Active Directory (AD)?"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Found on any Windows Server with AD Domain Services"}),"\n",(0,l.jsx)(i.li,{children:"Database of objects: User Accounts, Computers, Printers, File Shares, Security Groups"}),"\n",(0,l.jsx)(i.li,{children:"Centralized security management, create account, assign permissions"}),"\n",(0,l.jsx)(i.li,{children:"Objects are organized in trees"}),"\n",(0,l.jsx)(i.li,{children:"A group of trees is a forest"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"aws-directory-services",children:"AWS Directory Services"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["AWS Managed Microsoft AD","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Create your own AD in AWS, manage users locally, supports MFA"}),"\n",(0,l.jsx)(i.li,{children:"Establish \u201ctrust\u201d connections with your on premise AD"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["AD Connector","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Directory Gateway (proxy) to redirect to on premise AD, supports MFA"}),"\n",(0,l.jsx)(i.li,{children:"Users are managed on the on-premise AD"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["Simple AD","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"AD-compatible managed directory on AWS"}),"\n",(0,l.jsx)(i.li,{children:"Cannot be joined with on-premise AD"}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,l.jsx)(i,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},70220:(e,i,n)=>{n.d(i,{A:()=>s});const s=n.p+"assets/images/cross-account-sts-8282b35133f0cd2ed2291b156f3308a6.png"},19347:(e,i,n)=>{n.d(i,{A:()=>s});const s=n.p+"assets/images/iam-cross-account-df812e76f6198e8a1719ad46a7f7d64f.png"},60689:(e,i,n)=>{n.d(i,{A:()=>s});const s=n.p+"assets/images/iam-pass-role-6887dfd120cc298ad57860e08ca0de9e.png"},27181:(e,i,n)=>{n.d(i,{A:()=>s});const s=n.p+"assets/images/sts-to-assume-a-role-46d068d661c57a8dfb396da1e8042cb6.png"},16744:(e,i,n)=>{n.d(i,{A:()=>s});const s=n.p+"assets/images/trust-policy-3f2f18d57891ec09d79e89276f54ac6a.png"},28453:(e,i,n)=>{n.d(i,{R:()=>c,x:()=>t});var s=n(96540);const l={},r=s.createContext(l);function c(e){const i=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function t(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),s.createElement(r.Provider,{value:i},e.children)}}}]);