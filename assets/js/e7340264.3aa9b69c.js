"use strict";(self.webpackChunklearning_knowledge_base=self.webpackChunklearning_knowledge_base||[]).push([[5702],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>b});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=o.createContext({}),l=function(e){var t=o.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return o.createElement(c.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=l(n),m=a,b=d["".concat(c,".").concat(m)]||d[m]||u[m]||r;return n?o.createElement(b,i(i({ref:t},p),{},{components:n})):o.createElement(b,i({ref:t},p))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=m;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s[d]="string"==typeof e?e:a,i[1]=s;for(var l=2;l<r;l++)i[l]=n[l];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6120:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var o=n(7462),a=(n(7294),n(3905));const r={id:"dbcontext",title:"DbContext",sidebar_position:1},i=void 0,s={unversionedId:"c-sharp/entity-framework/dbcontext",id:"c-sharp/entity-framework/dbcontext",title:"DbContext",description:"The DbContext lifetime",source:"@site/docs/c-sharp/entity-framework/DbContext.md",sourceDirName:"c-sharp/entity-framework",slug:"/c-sharp/entity-framework/dbcontext",permalink:"/LearningCollection/c-sharp/entity-framework/dbcontext",draft:!1,editUrl:"https://github.com/RobinTTY/LearningCollection/tree/master/website/docs/c-sharp/entity-framework/DbContext.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"dbcontext",title:"DbContext",sidebar_position:1},sidebar:"finance",previous:{title:"ASP.NET REST APIs",permalink:"/LearningCollection/c-sharp/asp-net/aspnet"},next:{title:"Integration Testing",permalink:"/LearningCollection/c-sharp/entity-framework/integration-testing"}},c={},l=[{value:"The DbContext lifetime",id:"the-dbcontext-lifetime",level:2},{value:"DbContext in dependency injection",id:"dbcontext-in-dependency-injection",level:2},{value:"Basic usage",id:"basic-usage",level:3},{value:"Adding a pooled DbContext",id:"adding-a-pooled-dbcontext",level:3},{value:"<code>AddDbContextPool</code> vs <code>AddDbContextFactory</code>",id:"adddbcontextpool-vs-adddbcontextfactory",level:4}],p={toc:l},d="wrapper";function u(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"the-dbcontext-lifetime"},"The DbContext lifetime"),(0,a.kt)("p",null,"The lifetime of a ",(0,a.kt)("inlineCode",{parentName:"p"},"DbContext")," begins when the instance is created and ends when the instance is disposed. A DbContext instance is designed to be used for a single ",(0,a.kt)("a",{parentName:"p",href:"https://www.martinfowler.com/eaaCatalog/unitOfWork.html"},"unit-of-work"),". This means that the lifetime of a ",(0,a.kt)("inlineCode",{parentName:"p"},"DbContext")," instance is usually very short."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"A ",(0,a.kt)("strong",{parentName:"p"},"Unit of Work")," keeps track of everything you do during a business transaction that can affect the database. When you're done, it figures out everything that needs to be done to alter the database as a result of your work.")),(0,a.kt)("p",null,"A typical unit-of-work when using Entity Framework Core (EF Core) involves:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Creation of a ",(0,a.kt)("inlineCode",{parentName:"li"},"DbContext")," instance"),(0,a.kt)("li",{parentName:"ul"},"Tracking of entity instances by the context. Entities become tracked by",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Being ",(0,a.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/ef/core/querying/tracking"},"returned from a query")),(0,a.kt)("li",{parentName:"ul"},"Being ",(0,a.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/ef/core/saving/disconnected-entities"},"added or attached to the context")))),(0,a.kt)("li",{parentName:"ul"},"Changes are made to the tracked entities as needed to implement the business rule"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechanges"},(0,a.kt)("inlineCode",{parentName:"a"},"SaveChanges"))," or ",(0,a.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync"},(0,a.kt)("inlineCode",{parentName:"a"},"SaveChangesAsync"))," is called. EF Core detects the changes made and writes them to the database."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"DbContext")," instance is disposed")),(0,a.kt)("admonition",{type:"danger"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"DbContext is not thread-safe"),". Do not share contexts between threads. Make sure to await all async calls before continuing to use the context instance."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"It is very important to dispose the ",(0,a.kt)("inlineCode",{parentName:"strong"},"DbContext")," after use"),". This ensures both that any unmanaged resources are freed, and that any events or other hooks are unregistered so as to prevent memory leaks in case the instance remains referenced."),(0,a.kt)("li",{parentName:"ul"},"An ",(0,a.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/dotnet/api/system.invalidoperationexception"},"InvalidOperationException")," thrown by EF Core code can put the context into an unrecoverable state. Such exceptions indicate a program error and are not designed to be recovered from."))),(0,a.kt)("h2",{id:"dbcontext-in-dependency-injection"},"DbContext in dependency injection"),(0,a.kt)("p",null,"In many web applications, each HTTP request corresponds to a single unit-of-work. This makes tying the context lifetime to that of the request a good default for web applications."),(0,a.kt)("h3",{id:"basic-usage"},"Basic usage"),(0,a.kt)("p",null,"ASP.NET Core applications are ",(0,a.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup"},"configured using dependency injection"),". EF Core can be added to this configuration using ",(0,a.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkservicecollectionextensions.adddbcontext"},"AddDbContext")," in the ",(0,a.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup#the-configureservices-method"},"ConfigureServices")," method of Startup.cs. For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'public void ConfigureServices(IServiceCollection services)\n{\n    services.AddControllers();\n\n    services.AddDbContext<ApplicationDbContext>(\n        options => options.UseSqlServer("name=ConnectionStrings:DefaultConnection"));\n}\n')),(0,a.kt)("p",null,"This example registers a ",(0,a.kt)("inlineCode",{parentName:"p"},"DbContext")," subclass called ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationDbContext")," as a scoped service in the ASP.NET Core application service provider (a.k.a. the dependency injection container). The context is configured to use the SQL Server database provider and will read the connection string from ASP.NET Core configuration. It typically does not matter where in ",(0,a.kt)("inlineCode",{parentName:"p"},"ConfigureServices")," the call to ",(0,a.kt)("inlineCode",{parentName:"p"},"AddDbContext")," is made."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationDbContext")," class must expose a public constructor with a ",(0,a.kt)("inlineCode",{parentName:"p"},"DbContextOptions<ApplicationDbContext>")," parameter. This is how context configuration from ",(0,a.kt)("inlineCode",{parentName:"p"},"AddDbContext")," is passed to the ",(0,a.kt)("inlineCode",{parentName:"p"},"DbContext"),". For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"public class ApplicationDbContext : DbContext\n{\n    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)\n        : base(options)\n    {\n    }\n}\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"DbContextOptions")," can be created and the constructor can be called explicitly:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'var contextOptions = new DbContextOptionsBuilder<ApplicationDbContext>()\n    .UseSqlServer(@"Server=(localdb)\\mssqllocaldb;Database=Test")\n    .Options;\n\nusing var context = new ApplicationDbContext(contextOptions);\n')),(0,a.kt)("h3",{id:"adding-a-pooled-dbcontext"},"Adding a pooled DbContext"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"builder.Services.AddDbContextPool<MyDbContext>(options =>\n{\n    options.UseSqlServer(connstr);\n});\n\nbuilder.Services.AddDbContextFactory<MyDbContext>(options =>\n{\n    options.UseSqlServer(connstr);\n});\n")),(0,a.kt)("h4",{id:"adddbcontextpool-vs-adddbcontextfactory"},(0,a.kt)("inlineCode",{parentName:"h4"},"AddDbContextPool")," vs ",(0,a.kt)("inlineCode",{parentName:"h4"},"AddDbContextFactory")),(0,a.kt)("p",null,"Both ",(0,a.kt)("inlineCode",{parentName:"p"},"AddDbContextPool")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"AddDbContextFactory")," return a scoped instance of a ",(0,a.kt)("inlineCode",{parentName:"p"},"MyDbContext")," from the DI.\n",(0,a.kt)("inlineCode",{parentName:"p"},"AddDbContextFactory")," gives you the ability to create and manage DbContext instances yourself:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"using (var context = _contextFactory.CreateDbContext())\n{\n    // ...\n}\n")),(0,a.kt)("p",null,"That's useful when you don't have an explicit Unit of Work (e.g. request) or you want to keep the Context instance short-lived (during an intensive data pipeline task, as too many operations against the same instance can get very slow)."))}u.isMDXComponent=!0}}]);